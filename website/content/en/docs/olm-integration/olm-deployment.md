---
title: Testing Operator Deployment with OLM
linkTitle: Test Deployment
weight: 4
---

The [Operator Lifecycle Manager (OLM)][olm] is a set of cluster resources that
manage the lifecycle of an Operator. The Operator SDK provides an entrypoint for
deploying your Operator using an OLM-enabled Kubernetes cluster through
[`operator-sdk run --olm`][cli-run-olm], added in [v0.15.0][sdk-release-v0.15.0].
This command is currently intended for testing only.

This document assumes you are familiar with OLM and related terminology, and have
read the SDK-OLM integration [design proposal][sdk-olm-design].

`run --olm` assumes OLM is already installed and running on your cluster. If not,
you can install OLM by running [`operator-sdk olm install`][cli-olm-install].
You can check the status of OLM by running [`operator-sdk olm status`][cli-olm-status].

`run --olm` also assumes you have valid [Operator bundle][operator-bundle]
manifests and metadata available on disk. You can create manifests using
[`operator-sdk generate csv`][cli-generate-csv], which will create a [`ClusterServiceVersion` (CSV)][csv]
in and copy your `CustomResourceDefinition`'s to a manifests directory.
Then create metadata using [`operator-sdk bundle create --generate-only`][cli-bundle-create].

**Note:** before continuing, please read the [caveats](#caveats) section below.

## `operator-sdk run --olm` command overview

Let's look at the anatomy of the command:

```console
$ operator-sdk run --help
Run an Operator in a variety of environments

Usage:
  operator-sdk run [flags]

Flags:
      --kubeconfig string           The file path to kubernetes configuration file. Defaults to location specified by $KUBECONFIG, or to default file rules if not set
      --olm                         The operator to be run will be managed by OLM in a cluster. Cannot be set with another run-type flag
      --olm-namespace string        [olm only] The namespace where OLM is installed (default "olm")
      --operator-namespace string   [olm only] The namespace where operator resources are created in --olm mode. It must already exist in the cluster or be defined in a manifest passed to IncludePaths.
      --manifests string            [olm only] Directory containing package manifest and operator bundles.
      --operator-version string     [olm only] Version of operator to deploy
      --install-mode string         [olm only] InstallMode to create OperatorGroup with. Format: InstallModeType=[ns1,ns2[, ...]]
      --include strings             [olm only] Path to Kubernetes resource manifests, ex. Role, Subscription. These supplement or override defaults generated by run/cleanup
      --timeout duration            [olm only] Time to wait for the command to complete before failing (default 2m0s)
      ...
```

These flags correspond to options in the `OLMCmd` configuration model (names are similar if not identical):

```go
type OLMCmd struct {
  // KubeconfigPath is the local path to a kubeconfig. This uses well-defined
  // default loading rules to load the config if empty.
  KubeconfigPath string
  // OLMNamespace is the namespace in which OLM is installed.
  OLMNamespace string
  // OperatorNamespace is the cluster namespace in which operator resources
  // are created.
  // OperatorNamespace must already exist in the cluster or be defined in
  // a manifest passed to IncludePaths.
  OperatorNamespace string
  // ManifestsDir is a directory containing a package manifest and N bundles
  // of the operator's CSV and CRD's. OperatorVersion can be set to the
  // version of the desired operator version's subdir and Run()/Cleanup() will
  // deploy the operator version in that subdir.
  ManifestsDir string
  // OperatorVersion is the version of the operator to deploy. It must be
  // a semantic version, ex. 0.1.0.
  OperatorVersion string
  // InstallMode specifies which supported installMode should be used to
  // create an OperatorGroup. The format for this field is as follows:
  //
  // "InstallModeType=[ns1,ns2[, ...]]"
  //
  // The InstallModeType string passed must be marked as "supported" in the
  // CSV being installed. The namespaces passed must exist or be created by
  // passing a Namespace manifest to IncludePaths. An empty set of namespaces
  // can be used for AllNamespaces.
  // The default mode is OwnNamespace, which uses OperatorNamespace or the
  // kubeconfig default.
  InstallMode string
  // IncludePaths are path to manifests of Kubernetes resources that either
  // supplement or override defaults generated by methods of OLMCmd. These
  // manifests can be but are not limited to: RBAC, Subscriptions,
  // CatalogSources, OperatorGroups.
  //
  // Kinds that are overridden if supplied:
  // - CatalogSource
  // - Subscription
  // - OperatorGroup
  IncludePaths []string
  // Timeout dictates how long to wait for a REST call to complete. A call
  // exceeding Timeout will generate an error.
  Timeout time.Duration
}
```

Most of the above configuration options do not need explanation beyond their descriptions.
The following options require more clarification:

- `--operator-version` must match the version of the CSV manifest found in a manifests directory,
ex. `deploy/olm-catalog/<operator-name>/manifests` in an SDK Operator project.
- `--include` can be used if you have an existing set of manifests outside your
bundle (ex. catalog manifests like a `Subscription`, `CatalogSource`, and/or `OperatorGroup`)
you wish to facilitate Operator deployment with.
  - Currently any manifests supplied to this command will be created with the same
  behavior of `kubectl create -f <manifest-path>`.
  - If a `Subscription` or `CatalogSource` are supplied, the other must be supplied
  since they are linked by field references.
- `--install-mode` configures the `spec.targetNamespaces` field of an `OperatorGroup`,
and supports the following modes (assuming your CSV does as well):
  - `OwnNamespace`: the Operator will watch its own namespace. This is the default.
  - `SingleNamespace`: the Operator will watch a namespace, not necessarily its own.
  - `MultiNamespace`: the Operator will watch multiple namespaces.
  Example: `--install-mode=MultiNamespace=my-ns-1,my-ns-2` will watch resources in namespaces `my-ns-1` and `my-ns-2`.
  - `AllNamespaces`: the Operator will watch all namespaces (cluster-scoped Operators).
  Example: `--install-mode=AllNamespaces=""` will watch resources in all namespaces given

### Caveats

- `operator-sdk run` (and `operator-sdk cleanup`) are intended to be used for testing
purposes only as of now, since this command creates a transient image registry that
should not be used in production. Typically a registry is deployed eparately and a
set of catalog manifests are created in the cluster to inform OLM
of that registry and which Operator versions it can deploy and where to deploy the Operator.
- `operator-sdk run` can only deploy one Operator and one version of that Operator
at a time, hence its intended purpose being testing only.


[olm]:https://github.com/operator-framework/operator-lifecycle-manager/
[csv]:https://github.com/operator-framework/operator-lifecycle-manager/blob/master/doc/design/building-your-csv.md
[pkg-manifest]:https://github.com/operator-framework/operator-lifecycle-manager/blob/master/doc/design/how-to-update-operators.md
[operator-bundle]:https://github.com/operator-framework/operator-registry/tree/v1.5.3#manifest-format
[sdk-olm-design]:https://github.com/operator-framework/operator-sdk/blob/master/doc/proposals/sdk-integration-with-olm.md
[cli-olm-install]:/docs/cli/operator-sdk_olm_install
[cli-olm-status]:/docs/cli/operator-sdk_olm_status
[cli-run-olm]:/docs/cli/operator-sdk_run
[cli-generate-csv]:/docs/cli/operator-sdk_generate_csv
[cli-bundle-create]:/docs/cli/operator-sdk_bundle_create
[sdk-release-v0.15.0]:https://github.com/operator-framework/operator-sdk/releases/tag/v0.15.0
