// Copyright 2020 The Operator-SDK Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package testutils

import (
	"fmt"
	"io/ioutil"
	"path/filepath"

	kbutil "sigs.k8s.io/kubebuilder/v3/pkg/plugin/util"

	_ "sigs.k8s.io/kubebuilder/v3/pkg/config/v2" // Register config/v2 for `config.New`
	_ "sigs.k8s.io/kubebuilder/v3/pkg/config/v3" // Register config/v3 for `config.New`

	"github.com/operator-framework/operator-sdk/internal/util/projutil"
)

const (
	OlmVersionForTestSuite = "0.20.0"
)

var makefilePackagemanifestsFragment = `
# Options for "packagemanifests".
ifneq ($(origin FROM_VERSION), undefined)
PKG_FROM_VERSION := --from-version=$(FROM_VERSION)
endif
ifneq ($(origin CHANNEL), undefined)
PKG_CHANNELS := --channel=$(CHANNEL)
endif
ifeq ($(IS_CHANNEL_DEFAULT), 1)
PKG_IS_DEFAULT_CHANNEL := --default-channel
endif
PKG_MAN_OPTS ?= $(PKG_FROM_VERSION) $(PKG_CHANNELS) $(PKG_IS_DEFAULT_CHANNEL)

# Generate package manifests.
packagemanifests: kustomize %s
	operator-sdk generate kustomize manifests -q --interactive=false
	cd config/manager && $(KUSTOMIZE) edit set image controller=$(IMG)
	$(KUSTOMIZE) build config/manifests | operator-sdk generate packagemanifests -q --version $(VERSION) $(PKG_MAN_OPTS)
`

// AddPackagemanifestsTarget will append the packagemanifests target to the makefile
// in order to test the steps described in the docs.
// More info:  https://v1-0-x.sdk.operatorframework.io/docs/olm-integration/generation/#package-manifests-formats
func (tc TestContext) AddPackagemanifestsTarget(operatorType projutil.OperatorType) error {
	makefileBytes, err := ioutil.ReadFile(filepath.Join(tc.Dir, "Makefile"))
	if err != nil {
		return err
	}

	// add the manifests target when is a Go project.
	replaceTarget := ""
	if operatorType == projutil.OperatorTypeGo {
		replaceTarget = "manifests"
	}
	makefilePackagemanifestsFragment = fmt.Sprintf(makefilePackagemanifestsFragment, replaceTarget)

	// update makefile by adding the packagemanifests target
	makefileBytes = append([]byte(makefilePackagemanifestsFragment), makefileBytes...)
	err = ioutil.WriteFile(filepath.Join(tc.Dir, "Makefile"), makefileBytes, 0644)
	if err != nil {
		return err
	}
	return nil
}

// DisableOLMBundleInterativeMode will update the Makefile to disable the interactive mode
func (tc TestContext) DisableManifestsInteractiveMode() error {
	// Todo: check if we cannot improve it since the replace/content will exists in the
	// pkgmanifest target if it be scaffolded before this call
	content := "operator-sdk generate kustomize manifests"
	replace := content + " --interactive=false"
	return ReplaceInFile(filepath.Join(tc.Dir, "Makefile"), content, replace)
}

// GenerateBundle runs all commands to create an operator bundle.
func (tc TestContext) GenerateBundle() error {
	if err := tc.DisableManifestsInteractiveMode(); err != nil {
		return err
	}

	if err := tc.Make("bundle", "IMG="+tc.ImageName); err != nil {
		return err
	}

	err := tc.updateBundleWithDefaultRequirements()
	if err != nil {
		return err
	}

	return nil
}

// updateBundleWithDefaultRequirements will ensure that we set the values
// required to the bundle complay with the validator and checks done with the operator-framework suite
func (tc TestContext) updateBundleWithDefaultRequirements() error {
	bundleManifestPath := filepath.Join(tc.Dir, "bundle", "manifests", "memcached-operator.clusterserviceversion.yaml")

	// add icon since it is mandatory to publish on OperatorHub and then, we
	// would like to show it works
	const iconEmpty = `  icon:
  - base64data: ""
    mediatype: ""`

	const iconFilled = `  icon:
  - base64data: "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"
    mediatype: "image/png"`

	if err := ReplaceInFile(bundleManifestPath, iconEmpty, iconFilled); err != nil {
		return err
	}

	// add min Kubernetes version so that bundles tested with the default
	// operator-framework bundle validation suit does not raise warns
	if err := kbutil.InsertCode(bundleManifestPath, "version: 0.0.1", `
  minKubeVersion: 1.19
`); err != nil {
		return err
	}
	return nil
}
